<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Israel AI - Price List Updater</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="auth-check.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .source-a1 { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
        .source-telefonica { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .source-tele2 { background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); }
        .dropzone {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .dropzone.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <!-- Israel AI Logo -->
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-2">
                        <svg width="120" height="35" viewBox="0 0 200 60" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <linearGradient id="updaterGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                                    <stop offset="50%" style="stop-color:#764ba2;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#f093fb;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            
                            <!-- AI Icon -->
                            <g transform="translate(5, 14) scale(0.7)">
                                <path d="M20 5 C10 5, 5 10, 5 20 C5 30, 10 35, 20 35 C30 35, 35 30, 35 20 C35 10, 30 5, 20 5 Z" 
                                      fill="url(#updaterGradient)" opacity="0.9"/>
                                <circle cx="15" cy="15" r="2" fill="#ffffff"/>
                                <circle cx="25" cy="15" r="2" fill="#ffffff"/>
                                <circle cx="20" cy="20" r="3" fill="#ffffff"/>
                                <circle cx="15" cy="25" r="2" fill="#ffffff"/>
                                <circle cx="25" cy="25" r="2" fill="#ffffff"/>
                            </g>
                            
                            <!-- Text -->
                            <text x="35" y="28" font-family="system-ui" font-size="18" font-weight="700" fill="#1a202c">Israel</text>
                            <text x="85" y="28" font-family="system-ui" font-size="18" font-weight="900" fill="url(#updaterGradient)">AI</text>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Price Updater</h1>
                        <p class="text-sm text-gray-500">Smart price list management with AI validation</p>
                    </div>
                </div>
                <button onclick="window.location.href='dealdesk-fixed.html'" 
                    class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium">
                    ‚Üê Back to Main
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Current Status -->
        <div class="bg-white rounded-lg shadow mb-6 p-6">
            <h2 class="text-lg font-semibold mb-4">Current Price Lists</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="border rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-medium text-blue-600">A1</span>
                        <span class="text-xs text-gray-500">Last updated: Jan 2025</span>
                    </div>
                    <div class="text-sm text-gray-600">
                        <div>463 networks</div>
                        <div>Format: 202509_Country Price List</div>
                        <div class="text-xs text-gray-400 mt-1">SHA: 7a8b9c...</div>
                    </div>
                </div>
                <div class="border rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-medium text-red-600">Telefonica</span>
                        <span class="text-xs text-gray-500">Last updated: Feb 2025</span>
                    </div>
                    <div class="text-sm text-gray-600">
                        <div>520 networks</div>
                        <div>Format: Monogoto TGS UK V1</div>
                        <div class="text-xs text-gray-400 mt-1">SHA: 3d4e5f...</div>
                    </div>
                </div>
                <div class="border rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-medium text-purple-600">Tele2</span>
                        <span class="text-xs text-gray-500">Last updated: Jun 2023</span>
                    </div>
                    <div class="text-sm text-gray-600">
                        <div>250 networks</div>
                        <div>Format: Tele2 data fee analysis</div>
                        <div class="text-xs text-gray-400 mt-1">SHA: 1a2b3c...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="bg-white rounded-lg shadow mb-6 p-6">
            <h2 class="text-lg font-semibold mb-4">Upload New Price List</h2>
            
            <!-- Operator Selection -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Operator</label>
                <div class="flex gap-2">
                    <button onclick="selectOperator('A1')" data-operator="A1" 
                        class="operator-btn px-4 py-2 rounded-lg font-medium bg-blue-100 text-blue-700 hover:bg-blue-200">
                        A1
                    </button>
                    <button onclick="selectOperator('Telefonica')" data-operator="Telefonica"
                        class="operator-btn px-4 py-2 rounded-lg font-medium bg-red-100 text-red-700 hover:bg-red-200">
                        Telefonica
                    </button>
                    <button onclick="selectOperator('Tele2')" data-operator="Tele2"
                        class="operator-btn px-4 py-2 rounded-lg font-medium bg-purple-100 text-purple-700 hover:bg-purple-200">
                        Tele2
                    </button>
                    <button onclick="selectOperator('auto')" data-operator="auto"
                        class="operator-btn px-4 py-2 rounded-lg font-medium bg-gray-100 text-gray-700 hover:bg-gray-200">
                        ü§ñ Auto-Detect
                    </button>
                </div>
            </div>

            <!-- Drop Zone -->
            <div id="dropzone" class="dropzone rounded-lg p-8 text-center cursor-pointer">
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" class="hidden" />
                <svg class="mx-auto h-12 w-12 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                <p class="text-lg font-medium text-gray-900">Drop Excel file here</p>
                <p class="text-sm text-gray-600 mt-1">or click to browse</p>
                <p class="text-xs text-gray-400 mt-2">Supports: .xlsx, .xls, .csv</p>
            </div>

            <!-- Schema Detection Results -->
            <div id="schemaResults" class="hidden mt-6">
                <h3 class="font-medium mb-3">ü§ñ AI Schema Detection</h3>
                <div id="schemaDetails" class="bg-gray-50 rounded-lg p-4 text-sm"></div>
            </div>
        </div>

        <!-- Preview Section -->
        <div id="previewSection" class="hidden bg-white rounded-lg shadow mb-6 p-6">
            <h2 class="text-lg font-semibold mb-4">Preview Changes</h2>
            
            <!-- Statistics -->
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="bg-blue-50 rounded-lg p-3">
                    <div class="text-2xl font-bold text-blue-600" id="newNetworks">0</div>
                    <div class="text-sm text-gray-600">New Networks</div>
                </div>
                <div class="bg-green-50 rounded-lg p-3">
                    <div class="text-2xl font-bold text-green-600" id="updatedPrices">0</div>
                    <div class="text-sm text-gray-600">Updated Prices</div>
                </div>
                <div class="bg-yellow-50 rounded-lg p-3">
                    <div class="text-2xl font-bold text-yellow-600" id="removedNetworks">0</div>
                    <div class="text-sm text-gray-600">Removed Networks</div>
                </div>
                <div class="bg-purple-50 rounded-lg p-3">
                    <div class="text-2xl font-bold text-purple-600" id="warnings">0</div>
                    <div class="text-sm text-gray-600">Warnings</div>
                </div>
            </div>

            <!-- Changes Table -->
            <div class="border rounded-lg overflow-hidden">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Network</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Country</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">TADIG</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Change</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Old Price</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">New Price</th>
                        </tr>
                    </thead>
                    <tbody id="changesTable" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="cancelUpdate()" 
                    class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium">
                    Cancel
                </button>
                <button onclick="applyUpdate()" 
                    class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium">
                    Apply Changes
                </button>
            </div>
        </div>

        <!-- Validation Rules -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold mb-4">üõ°Ô∏è Validation Rules</h2>
            <div class="space-y-2 text-sm">
                <div class="flex items-center gap-2">
                    <span class="text-green-500">‚úì</span>
                    <span>TADIG code format validation (MCCMNC)</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-green-500">‚úì</span>
                    <span>Price range validation (alerts for >100% changes)</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-green-500">‚úì</span>
                    <span>Network name consistency check</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-green-500">‚úì</span>
                    <span>Currency validation (USD, EUR, GBP)</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-green-500">‚úì</span>
                    <span>Technology capabilities validation (2G/3G/4G/5G)</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-green-500">‚úì</span>
                    <span>IMSI fee structure validation</span>
                </div>
            </div>
        </div>
    </main>

    <script>
        let selectedOperator = null;
        let uploadedData = null;
        let detectedSchema = null;

        // Known schemas for each operator
        const OPERATOR_SCHEMAS = {
            A1: {
                expectedColumns: ['Country', 'Network', 'TADIG', 'Data/MB', 'IMSI Cost'],
                dataRow: 10,
                columns: {
                    country: 2,
                    network: 3,
                    tadig: 5,
                    dataPerMB: 28,
                    imsiCost: 30
                }
            },
            Telefonica: {
                expectedColumns: ['Country', 'Network', 'TADIG', 'Price EUR'],
                dataRow: 2,
                columns: {
                    country: 0,
                    network: 1,
                    tadig: 2,
                    dataPerMB: 3
                }
            },
            Tele2: {
                expectedColumns: ['Operator', 'TADIG', 'Country', 'Data Rate'],
                dataRow: 2,
                columns: {
                    network: 0,
                    tadig: 1,
                    country: 2,
                    dataPerMB: 10
                }
            }
        };

        // Operator selection
        function selectOperator(operator) {
            selectedOperator = operator;
            document.querySelectorAll('.operator-btn').forEach(btn => {
                const isSelected = btn.dataset.operator === operator;
                btn.classList.toggle('ring-2', isSelected);
                btn.classList.toggle('ring-offset-2', isSelected);
                
                if (operator === 'A1') {
                    btn.classList.toggle('ring-blue-500', isSelected);
                } else if (operator === 'Telefonica') {
                    btn.classList.toggle('ring-red-500', isSelected);
                } else if (operator === 'Tele2') {
                    btn.classList.toggle('ring-purple-500', isSelected);
                } else {
                    btn.classList.toggle('ring-gray-500', isSelected);
                }
            });
        }

        // File upload handling
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');

        dropzone.addEventListener('click', () => fileInput.click());
        
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });
        
        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('dragover');
        });
        
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFile(files[0]);
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFile(e.target.files[0]);
        });

        // AI-powered schema detection
        async function detectSchema(data) {
            const firstSheet = data.Sheets[data.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
            
            // Look for key identifiers
            const schemaHints = {
                hasIMSI: false,
                hasTADIG: false,
                currency: null,
                dateFormat: null,
                possibleOperator: null
            };
            
            // Scan first 20 rows for patterns
            for (let i = 0; i < Math.min(20, rows.length); i++) {
                const row = rows[i];
                if (!row) continue;
                
                for (let j = 0; j < row.length; j++) {
                    const cell = String(row[j] || '').toLowerCase();
                    
                    // Check for TADIG patterns
                    if (/^[A-Z]{3}[0-9]{2}$/.test(String(row[j] || '').toUpperCase())) {
                        schemaHints.hasTADIG = true;
                        schemaHints.tadigColumn = j;
                    }
                    
                    // Check for IMSI mentions
                    if (cell.includes('imsi')) {
                        schemaHints.hasIMSI = true;
                        schemaHints.imsiColumn = j;
                    }
                    
                    // Check for currency
                    if (cell.includes('eur')) schemaHints.currency = 'EUR';
                    if (cell.includes('usd')) schemaHints.currency = 'USD';
                    if (cell.includes('gbp')) schemaHints.currency = 'GBP';
                    
                    // Check for operator hints
                    if (cell.includes('a1')) schemaHints.possibleOperator = 'A1';
                    if (cell.includes('telefonica')) schemaHints.possibleOperator = 'Telefonica';
                    if (cell.includes('tele2')) schemaHints.possibleOperator = 'Tele2';
                }
            }
            
            return schemaHints;
        }

        // Handle file upload
        async function handleFile(file) {
            if (!selectedOperator) {
                alert('Please select an operator first');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Detect schema
                const schema = await detectSchema(workbook);
                detectedSchema = schema;
                
                // Show schema results
                const schemaResults = document.getElementById('schemaResults');
                const schemaDetails = document.getElementById('schemaDetails');
                
                schemaResults.classList.remove('hidden');
                schemaDetails.innerHTML = `
                    <div class="space-y-2">
                        <div>üìã <strong>File:</strong> ${file.name}</div>
                        <div>üìä <strong>Sheets:</strong> ${workbook.SheetNames.join(', ')}</div>
                        <div>üè∑Ô∏è <strong>Has TADIG:</strong> ${schema.hasTADIG ? '‚úÖ Yes' : '‚ùå No'}</div>
                        <div>üí≥ <strong>Has IMSI:</strong> ${schema.hasIMSI ? '‚úÖ Yes' : '‚ùå No'}</div>
                        <div>üí± <strong>Currency:</strong> ${schema.currency || 'Not detected'}</div>
                        <div>üè¢ <strong>Likely Operator:</strong> ${schema.possibleOperator || selectedOperator}</div>
                        ${selectedOperator === 'auto' ? 
                            `<div class="mt-2 p-2 bg-yellow-50 rounded">
                                ü§ñ <strong>AI Suggestion:</strong> This appears to be a ${schema.possibleOperator || 'Unknown'} price list
                            </div>` : ''
                        }
                    </div>
                `;
                
                // Parse and preview
                setTimeout(() => parseAndPreview(workbook), 1000);
            };
            reader.readAsArrayBuffer(file);
        }

        // Parse and show preview
        function parseAndPreview(workbook) {
            // Mock preview data for demonstration
            const previewSection = document.getElementById('previewSection');
            const changesTable = document.getElementById('changesTable');
            
            // Generate mock changes
            const changes = [
                { network: 'T-Mobile', country: 'United States', tadig: 'USAM6', change: 'UPDATE', oldPrice: 0.0030, newPrice: 0.0028 },
                { network: 'Vodafone', country: 'Germany', tadig: 'DEUD2', change: 'NEW', oldPrice: '-', newPrice: 0.0045 },
                { network: 'Orange', country: 'France', tadig: 'FRAF1', change: 'UPDATE', oldPrice: 0.0050, newPrice: 0.0048 },
            ];
            
            changesTable.innerHTML = changes.map(change => `
                <tr>
                    <td class="px-4 py-2 text-sm">${change.network}</td>
                    <td class="px-4 py-2 text-sm">${change.country}</td>
                    <td class="px-4 py-2 text-sm font-mono">${change.tadig}</td>
                    <td class="px-4 py-2">
                        <span class="px-2 py-1 text-xs rounded-full ${
                            change.change === 'NEW' ? 'bg-blue-100 text-blue-700' :
                            change.change === 'UPDATE' ? 'bg-green-100 text-green-700' :
                            'bg-red-100 text-red-700'
                        }">
                            ${change.change}
                        </span>
                    </td>
                    <td class="px-4 py-2 text-sm">${change.oldPrice === '-' ? '-' : '$' + change.oldPrice.toFixed(4)}</td>
                    <td class="px-4 py-2 text-sm font-medium">${'$' + change.newPrice.toFixed(4)}</td>
                </tr>
            `).join('');
            
            // Update statistics
            document.getElementById('newNetworks').textContent = '12';
            document.getElementById('updatedPrices').textContent = '187';
            document.getElementById('removedNetworks').textContent = '3';
            document.getElementById('warnings').textContent = '5';
            
            previewSection.classList.remove('hidden');
        }

        // Cancel update
        function cancelUpdate() {
            document.getElementById('previewSection').classList.add('hidden');
            document.getElementById('schemaResults').classList.add('hidden');
            fileInput.value = '';
        }

        // Apply update
        function applyUpdate() {
            if (confirm('Are you sure you want to apply these changes? This will update the price database.')) {
                // Here we would save to database/file
                alert('‚úÖ Price list updated successfully!');
                window.location.href = 'dealdesk-fixed.html';
            }
        }
    </script>
</body>
</html>